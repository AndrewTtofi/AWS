## Docker: How to create a docker swarm in AWS
##--------------------------------------------

##########################
##  Docker swarm setup  ##
##########################
# Prerequisites
# 1. AWS EC2 Linux 2 instance
# 2. docker 1.2 and above
# 3. docker machine
# 4. aws cli
# 5. IAM user with programetic access to create and manage EC2 instance
# 6. Your AWS VPC, Subnet, Security Groups and AZ info

##  Setup AWS environment variables that will be used to create the docker swarm nodes
export AWS_ACCESS_KEY_ID=<your_aws_access_key>
export AWS_SECRET_ACCESS_KEY=<your_aws_secret_key>
export AWS_DEFAULT_REGION=<your_aws_region>
export AWS_VPC_ID=<your_aws_vpc_id>
export AWS_AZ=<your_aws_availability_zone> #a,b,c,d,e...
export AWS_VPC_SUBNET=<your_aws_subnet_id>

##  Check if env variables are set
env | grep AWS*

#############################
##  Create a docker swarm  ##
#############################

##  Create the docker swarm manager node first.
docker-machine create -d amazonec2 --amazonec2-vpc-id $AWS_VPC_ID --amazonec2-region $AWS_DEFAULT_REGION --amazonec2-zone $AWS_AZ --amazonec2-instance-type t2.micro --amazonec2-subnet-id $AWS_VPC_SUBNET --amazonec2-security-group docker-swarm docker-swarm-manager

##  Create the two worker nodes
docker-machine create -d amazonec2 --amazonec2-vpc-id $AWS_VPC_ID --amazonec2-region $AWS_DEFAULT_REGION --amazonec2-zone $AWS_AZ --amazonec2-instance-type t2.micro --amazonec2-subnet-id $AWS_VPC_SUBNET --amazonec2-security-group docker-swarm docker-swarm-node1
docker-machine create -d amazonec2 --amazonec2-vpc-id $AWS_VPC_ID --amazonec2-region $AWS_DEFAULT_REGION --amazonec2-zone $AWS_AZ --amazonec2-instance-type t2.micro --amazonec2-subnet-id $AWS_VPC_SUBNET --amazonec2-security-group docker-swarm docker-swarm-node2

##  Check all the nodes
docker-machine ls



